<ion-header>
  <ion-toolbar>
    <ion-title>Service Marketplace</ion-title>
    <ion-buttons slot="end">
      <badge-menu-button></badge-menu-button>
    </ion-buttons>
  </ion-toolbar>
  <ion-toolbar *ngIf="!pageLoading">
    <ion-searchbar (ionChange)="search($event)" debounce="400"></ion-searchbar>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding-top">
  <text-spinner *ngIf="pageLoading; else pageLoaded" text="Loading Marketplace"></text-spinner>

  <ng-template #pageLoaded>
    <ion-card *ngIf="eos" class="eos-card" (click)="updateEos()">
      <ion-card-header>
        <ion-card-subtitle>Now Available...</ion-card-subtitle>
        <ion-card-title>EmbassyOS Version {{ eos.version }}</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        {{ eos.headline }}
      </ion-card-content>
    </ion-card>

    <h2 class="ion-margin-start">Categories</h2>

    <div class="scrollable">
      <ion-button
        *ngFor="let cat of data.categories"
        fill="clear"
        [color]="cat === category ? 'primary' : 'dark'"
        [class.cat-selected]="cat === category"
        (click)="switchCategory(cat)"
      >
        {{ cat }}
      </ion-button>
    </div>

    <div *ngIf="pkgsLoading; else loaded" style="margin-top: 64px;" class="ion-text-center">
      <text-spinner [text]="'Loading ' + (category | titlecase)"></text-spinner>
    </div>

    <ng-template #loaded>
      <ion-grid>
        <ion-row>
          <ion-col *ngFor="let pkg of pkgs" sizeXs="12" sizeSm="12" sizeMd="6">
            <ion-item [routerLink]="['/marketplace', pkg.manifest.id]">
              <ion-thumbnail slot="start">
                <img [src]="pkg.icon" />
              </ion-thumbnail>
              <ion-label>
                <h2 style="font-family: 'Montserrat';">{{ pkg.manifest.title }}</h2>
                <p>{{ pkg.manifest.description.short }}</p>
                <ng-container *ngIf="localPkgs[pkg.manifest.id] as localPkg">
                  <p *ngIf="localPkg.state === PackageState.Installed">
                    <ion-text *ngIf="(pkg.manifest.version | compareEmver : localPkg.manifest.version) === 0" color="success">Installed</ion-text>
                    <ion-text *ngIf="(pkg.manifest.version | compareEmver : localPkg.manifest.version) === 1" color="warning">Update Available</ion-text>
                  </p>
                  <p *ngIf="localPkg.state === PackageState.Installing" style="display: flex; flex-direction: row; align-items: center;">
                    <ion-text color="primary">Installing</ion-text>
                    <ion-spinner name="crescent" style="height: 10px; width: 15px; margin-left: 3px; margin-right: -4px;" color="primary"></ion-spinner>
                  </p>
                  <p *ngIf="localPkg.state === PackageState.Updating" style="display: flex; flex-direction: row; align-items: center;">
                    <ion-text color="primary">Updating</ion-text>
                    <ion-spinner name="crescent" style="height: 10px; width: 15px; margin-left: 3px; margin-right: -4px;" color="primary"></ion-spinner>
                  </p>
                  <p *ngIf="localPkg.state === PackageState.Removing" style="display: flex; flex-direction: row; align-items: center;">
                    <ion-text color="danger">Removing</ion-text>
                    <ion-spinner name="crescent" style="height: 10px; width: 15px; margin-left: 3px; margin-right: -4px;" color="danger"></ion-spinner>
                  </p>
                </ng-container>
              </ion-label>
            </ion-item>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ng-template>
  </ng-template>
  <ion-infinite-scroll [disabled]="!needInfinite" (ionInfinite)="doInfinite($event)">
    <ion-infinite-scroll-content loadingSpinner="lines"></ion-infinite-scroll-content>
  </ion-infinite-scroll>
  
</ion-content>
